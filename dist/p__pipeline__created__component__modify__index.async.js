"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[156],{17365:function(Ae,M,l){l.d(M,{Q:function(){return G}});var G=[{id:1,icon:"icon-placeholder_1",name:"base1",setting:{trigger_type:"HOOK",git_info:{},enabled:!0,run_lock_type:!0,notification:{success:{},failed:{},canceled:{}}},template:[{id:"1",name:"stage",type:1,active:!0,jobs:[{id:"1-1",name:"job",type:2,active:!0,allow_failure:!1,tasks:[{id:"1-1-1",name:"task",atom_id:"",type:3,vaildFormError:!0,active:!0,allow_failure:!1,run_condition:"pre_task_success"},{id:"1-1-2",name:"task",atom_id:"",type:3,vaildFormError:!0,active:!0,allow_failure:!1,run_condition:"pre_task_success"}]}]}]}]},50965:function(Ae,M,l){l.r(M),l.d(M,{default:function(){return ot}});var G=l(15009),f=l.n(G),Re=l(97857),d=l.n(Re),ke=l(99289),j=l.n(ke),Me=l(19632),B=l.n(Me),Be=l(5574),D=l.n(Be),p=l(62435),se=l(14754),le=l(59259),ue=l(68872),oe=l(55241),Ne=l(87462),Pe={icon:{tag:"svg",attrs:{"fill-rule":"evenodd",viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112c17.7 0 32 14.3 32 32v736c0 17.7-14.3 32-32 32H144c-17.7 0-32-14.3-32-32V144c0-17.7 14.3-32 32-32zm-40 72H184v656h656V184zM640.01 338.83c.03 0 .05.01.09.06l45.02 45.01a.2.2 0 01.05.09.12.12 0 010 .07c0 .02-.01.04-.05.08L557.25 512l127.87 127.86a.27.27 0 01.05.06v.02a.12.12 0 010 .07c0 .03-.01.05-.05.09l-45.02 45.02a.2.2 0 01-.09.05.12.12 0 01-.07 0c-.02 0-.04-.01-.08-.05L512 557.25 384.14 685.12c-.04.04-.06.05-.08.05a.12.12 0 01-.07 0c-.03 0-.05-.01-.09-.05l-45.02-45.02a.2.2 0 01-.05-.09.12.12 0 010-.07c0-.02.01-.04.06-.08L466.75 512 338.88 384.14a.27.27 0 01-.05-.06l-.01-.02a.12.12 0 010-.07c0-.03.01-.05.05-.09l45.02-45.02a.2.2 0 01.09-.05.12.12 0 01.07 0c.02 0 .04.01.08.06L512 466.75l127.86-127.86c.04-.05.06-.06.08-.06a.12.12 0 01.07 0z"}}]},name:"close-square",theme:"outlined"},Ze=Pe,Oe=l(84089),Ve=function(h,w){return p.createElement(Oe.Z,(0,Ne.Z)({},h,{ref:w,icon:Ze}))},He=p.forwardRef(Ve),ze=He,Ye=l(60219),ce=l(77683),Ke=[{id:2,name:"\u57FA\u7840\u8BBE\u7F6E"},{id:1,name:"\u6D41\u6C34\u7EBF"},{id:3,name:"\u901A\u77E5"}],Ot=function(){return{id:1,name:"stage-1",type:1,jobs:[],showAddButton:!1}},Vt=function(){return{id:1,name:"job",type:2,tasks:[]}},Ht=function(){return{id:1,name:"\u8BF7\u9009\u62E9\u63D2\u4EF6",type:3,plugin:""}},b=l(74877),de=l(88026),Qe=l(90930),Ge=l(866),Ue=l(88731),Je=l(53515),We=l(12570),u=l(86074);function Xe(g,h){var w=(0,p.useState)(!1),S=D()(w,2),T=S[0],P=S[1];(0,p.useImperativeHandle)(h,function(){return{open:Z}});var Z=function(fe){P(!0)},y=function(){P(!1)};return(0,u.jsx)(le.Z,{className:"device-manage-Load-modal",centered:!0,destroyOnClose:!0,footer:null,open:T,onCancel:y})}var qe=(0,p.forwardRef)(Xe),U=l(11238),zt=function(h,w){return request("/api/pipeline/config/".concat(h),{method:"post",data:w})},Yt=function(h,w){return request("/api/pipeline/config/".concat(h,"/update"),{method:"post",data:w})},Kt=function(h){return request("/api/pipeline/config/".concat(h),{method:"get"})},_e=function(h){return(0,U.ZP)("/api/pipeline/conf/can_edit",{method:"post",data:h})},et=function(h){return(0,U.ZP)("/api/pipeline/conf/can_edit",{method:"delete",params:h})},tt=function(h,w){return(0,U.ZP)("/api/pipeline/config/".concat(h,"/trigger_config"),{method:"post",data:w})},at=l(56292),nt=l(17365),rt=l(52610),it=l(30381),st=l.n(it),N=l(83056),lt=l(96974),Qt=le.Z.confirm;function ut(g){var h=(0,p.useState)(1),w=D()(h,2),S=w[0],T=w[1],P=(0,p.useState)(null),Z=D()(P,2),y=Z[0],k=Z[1],fe=(0,p.useState)(null),pe=D()(fe,2),O=pe[0],ct=pe[1],dt=(0,p.useState)(!1),ve=D()(dt,2),ft=ve[0],me=ve[1],pt=(0,p.useState)(!1),ge=D()(pt,2),vt=ge[0],mt=ge[1],E=(0,b.DP)(),m=(0,se.v9)(function(s){var r=s.pipeline;return r}),V=(0,se.I0)(),gt=(0,de.useModel)("@@initialState"),ht=gt.initialState,he=ht.currentUser,ye=he===void 0?{}:he,Ee=(0,de.useNavigate)(),$=(0,p.useRef)(null),yt=(0,p.useRef)(null),x=(0,p.useRef)(null),Fe=(0,p.useRef)(null),J=(0,p.useRef)({}),Gt=(0,p.useRef)(!1),W=(0,p.useRef)(!1),Ut=(0,p.useRef)(""),A={},Et=(0,lt.TH)();(0,p.useEffect)(function(){return T(E.tab*1||0),function(){var s;ye.id===((s=A)===null||s===void 0?void 0:s.user_id)&&we(),V({type:"pipeline/setList",payload:{list:B()(m.list),importData:{}}})}},[]),(0,p.useEffect)(function(){Ft(),wt()},[Et.search]),(0,p.useEffect)(function(){if(y){var s;$.current.isLoad,(s=$.current)!==null&&s!==void 0&&s.isModifyLoad?$.current.isModify=!0:$.current.isModifyLoad=!0}},[y]),(0,p.useEffect)(function(){return window.addEventListener("unload",je),window.addEventListener("beforeunload",Se),function(){window.removeEventListener("unload",je),window.removeEventListener("beforeunload",Se)}},[]);var Ft=function(){var s=j()(f()().mark(function r(){var n,a,i,o,e,v;return f()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:try{a=E.pipelineId,i=E.source,o=m.list.findIndex(function(F){return F.id*1===a*1}),e=m.list[o],e.stages=e.template,J.current=(0,b.p$)(e),(n=m.importData)!==null&&n!==void 0&&n.stages&&(e.stages=(0,b.p$)(m.importData.stages),e.setting=(0,b.p$)(m.importData.setting),e.run_lock_type=m.importData.run_lock_type,e.setting.hook_url=J.current.setting.hook_url,$.current.isModify=!0),(!e.stages||e.stages.length<=0)&&(e.stages=(0,b.p$)(nt.Q[0].template)),e.run_lock_type=!0,e.setting={trigger_type:"HOOK",git_info:{},enabled:!0,run_lock_type:!0,notification:{success:{},failed:{},canceled:{}}},W.current&&W.current.setExpandTask(e,(v=e.setting)===null||v===void 0||(v=v.extra_data)===null||v===void 0?void 0:v.isExpandAll),(0,rt.$)(e.stages),e.template=e.stages,e.iid=e.id,e.id=a,o<0?m.list.push((0,b.p$)(e)):m.list[o]=(0,b.p$)(e),V({type:"pipeline/setList",payload:{list:B()(m.list)}}),k(d()({},e)),ct(d()({},e))}catch(F){console.log(F)}finally{}case 1:case"end":return c.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),wt=function(){var s=j()(f()().mark(function r(){var n,a,i,o,e,v;return f()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,(0,at.cD)({uuid:E.pipelineId});case 2:n=c.sent,a=n||{},i=a.status,o=a.data,e=a.msg,v=a.success,A=d()(d()({},o),{},{status:i}),i&&St(),!i&&g.history.push((0,N.v4)("/FlowLine/created/preview?pipelineId=".concat(E.pipelineId,"&tab=").concat(S)));case 7:case"end":return c.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),St=function(){var s=j()(f()().mark(function r(){var n,a,i,o,e,v;return f()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,_e({uuid:E.pipelineId});case 2:n=c.sent,a=n||{},i=a.status,o=a.data,e=a.msg,v=a.success,A=d()(d()({},o),{},{status:i});case 5:case"end":return c.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),we=function(){var s=j()(f()().mark(function r(){var n,a,i;return f()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,et({uuid:E.pipelineId});case 2:return n=e.sent,A=d()(d()({},A),{},{status:!0}),a=n||{},i=a.success,e.abrupt("return",i);case 6:case"end":return e.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),Se=function(r){var n;ye.id===((n=A)===null||n===void 0?void 0:n.user_id)&&we(),r.returnValue=null},je=function(r){console.log(321)},jt=function(r){for(var n=0;n<r.length;n++){var a=r[n],i=n+1;if(a.vaildFormError)throw new Error("\u8BF7\u8F93\u5165\u6B63\u786E\u586B\u5199\u914D\u7F6E \u5177\u4F53\u4F4D\u7F6E\uFF1A".concat(i));for(var o=0;o<a.jobs.length;o++){var e=a.jobs[o],v="".concat(i,"-").concat(o+1);if(e.vaildFormError)throw new Error("\u8BF7\u8F93\u5165\u6B63\u786E\u586B\u5199\u914D\u7F6E \u5177\u4F53\u4F4D\u7F6E\uFF1A".concat(v));for(var t=0;t<e.tasks.length;t++){var c=e.tasks[t],F="".concat(v,"-").concat(t+1);if(c.vaildFormError)throw new Error("\u8BF7\u8F93\u5165\u6B63\u786E\u586B\u5199\u914D\u7F6E \u5177\u4F53\u4F4D\u7F6E\uFF1A".concat(F))}}}},Ct=function(){var r=window.location,n=r.origin,a=r.pathname,i=E.pipelineId;window.history.replaceState("","",n+a+"?pipelineId=".concat(i))},It=function(){var s=j()(f()().mark(function r(n){var a,i,o,e,v,t,c,F,H,X,q,_,z,R,C,Y,K,ee,te,Q,ae,Ce,Ie,be,Le,ne,re,xe,De,Te,ie,I,$e;return f()().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:return i=E.pipelineId,o=m.list.findIndex(function(Zt){return Zt.id===i}),e=m.list[o],L.next=5,Fe.current.getFormValue();case 5:return v=L.sent,L.next=8,x.current.getFormValue();case 8:return t=L.sent,c=t.name,F=t.description,H=t.run_lock_type,X=t.trigger_type,q=t.schedule,_=t.repo_url,z=t.timer_info,R=t.label,C=t.pipeline_env,Y=t.timeout,K=t.enabled,ee=t.is_public,te=t.magic_comment,Q=t.hook_url,ae=t.include_branch,Ce=t.exclude_branch,Ie=t.env,be=t.file_path,Le=t.repo_name,ne=t.envComponentList,re=t.relationList,xe=t.default_trigger_info,De=t.trigger_list,Te=t.history_limit,ie=t.isExpandAll,I={trigger_list:De,notification:v,file_path:be,pipeline_variable:Ie,trigger_type:(a=J.current)===null||a===void 0||(a=a.setting)===null||a===void 0?void 0:a.trigger_type,schedule:q,timer_info:z?st()(z).format("YYYY-MM-DD HH:mm:ss"):"",label:R,pipeline_env:C,timeout:Y,repo_name:Le,enabled:K,is_public:ee,magic_comment:te,hook_url:Q,description:F,include_branch:ae,exclude_branch:Ce,default_trigger_info:xe||[],extra_data:e.setting.extra_data||{},git_info:{repo_url:_},history_limit:Te},ne&&($e=(0,b.DP)().pipelineId,I.extra_data=I.extra_data||{},I.extra_data.envComponentList||(I.extra_data.envComponentList={}),I.extra_data.envComponentList[$e]=ne),ie!==void 0&&(I.extra_data.isExpandAll=ie),re&&(I.extra_data.relationList=re),n.run_lock_type=H,n.name=c,L.abrupt("return",I);case 41:case"end":return L.stop()}},r)}));return function(n){return s.apply(this,arguments)}}(),Jt=function(){var s=j()(f()().mark(function r(){var n,a,i;return f()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.current.getFormValue();case 2:return n=e.sent,a=n.trigger,i={exclude_branch:"",file_path:"",hook_from:"",hook_url:""},e.next=7,tt(y.iid,{trigger_config_data:a.map(function(v){return delete v.active,d()(d()({},i),v)})});case 7:case"end":return e.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),bt=function(){var s=j()(f()().mark(function r(){var n,a,i,o,e;return f()().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,me(!0),n=y.template,jt(n),a=E.pipelineId,i=E.from,o=m.list.findIndex(function(c){return c.id===a}),e={stages:xt(n),project_id:"test1"},t.next=9,It(e);case 9:e.setting=t.sent,Ct(),m.list[o]=d()(d()({},y),e),V({type:"pipeline/setList",payload:{list:B()(m.list)}}),ue.ZP.success("\u4FDD\u5B58\u6210\u529F"),Ee("/pipeline/created/preview?pipelineId=".concat(a,"&tab=").concat(S)),t.next=21;break;case 17:t.prev=17,t.t0=t.catch(0),console.log(t.t0),t.t0!==null&&t.t0!==void 0&&t.t0.message&&ue.ZP.error(t.t0===null||t.t0===void 0?void 0:t.t0.message);case 21:return t.prev=21,me(!1),t.finish(21);case 24:case"end":return t.stop()}},r,null,[[0,17,21,24]])}));return function(){return s.apply(this,arguments)}}(),Lt=function(){var s=j()(f()().mark(function r(){var n,a,i,o,e;return f()().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=E.pipelineId,a=m.list.findIndex(function(c){return c.id===n}),t.next=4,x.current.getFormValue();case 4:i=t.sent,o=i.env,e=i.default_trigger_info,y.setting.pipeline_variable=o,y.setting.default_trigger_info=e,m.list[a]=d()({},y),V({type:"pipeline/setList",payload:{list:B()(m.list)}});case 11:case"end":return t.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),xt=function(r){var n=[];return r.forEach(function(a,i){var o=a.name,e=a.id,v=a.type,t=a.vaildFormError,c=d()(d()({},a),{},{name:o,jobs:[],type:1,position:i});delete c.id,n.push(c),a.jobs.forEach(function(F,H){var X=F.name,q=F.id,_=F.type,z=F.vaildFormError,R=d()(d()({},F),{},{name:X,tasks:[],type:2,parallel_position:0,position:H});delete R.id,c.jobs.push(R),F.tasks.forEach(function(C,Y){var K=C.name,ee=C.id,te=C.type,Q=C.atom_id,ae=C.vaildFormError;delete C.id,R.tasks.push(d()(d()({},C),{},{name:K,type:3,position:Y,atom_id:Q}))})})}),n},Dt=function(){var s=j()(f()().mark(function r(){var n,a;return f()().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(n=E.pipelineId,a=E.from,a!=="add"){o.next=4;break}return g.history.goBack(),o.abrupt("return");case 4:Ee("/pipeline/created");case 5:case"end":return o.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),Tt=function(){var s=j()(f()().mark(function r(n){return f()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,Lt();case 3:T(n),i.next=8;break;case 6:i.prev=6,i.t0=i.catch(0);case 8:case"end":return i.stop()}},r,null,[[0,6]])}));return function(n){return s.apply(this,arguments)}}(),$t=function(){var s=j()(f()().mark(function r(){var n,a,i;return f()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x==null||(n=x.current)===null||n===void 0?void 0:n.getFormValue();case 2:return a=e.sent,i=(0,N.Sb)(a.env),e.abrupt("return",i);case 5:case"end":return e.stop()}},r)}));return function(){return s.apply(this,arguments)}}(),At=function(){return(0,u.jsxs)("div",{className:"content-tab flex-space-between",children:[(0,u.jsx)("div",{className:"flex-start",children:Ke.map(function(r,n){return(0,u.jsxs)("div",{className:"content-tab-item ".concat(n===S&&"item-action"),onClick:function(){return Tt(n)},children:[(0,u.jsx)("h3",{children:r.name}),n===S&&(0,u.jsx)("div",{className:"item-line"})]},r.id)})}),(0,u.jsxs)("div",{className:"flex-start content-tab-header-handle",children:[(0,u.jsx)(oe.Z,{content:"\u53D6\u6D88",children:(0,u.jsx)(ce.ZP,{className:"flex-center",onClick:Dt,icon:(0,u.jsx)(ze,{className:"flow-created-EditOutlined-icon"})})}),"\xA0\xA0",(0,u.jsx)(oe.Z,{content:"\u4FDD\u5B58",children:(0,u.jsx)(ce.ZP,{className:"flex-center",type:"primary",onClick:bt,loading:ft,icon:(0,u.jsx)(Ye.Z,{className:"flow-created-EditOutlined-icon"})})}),E.from!=="add"&&(0,u.jsx)(N.YH,d()(d()({data:y},g),{},{from:"add"}))]})]})},Rt=function(){return y?(0,u.jsx)("div",{className:"content-container common-content-container  ".concat(S===1&&"content-container-show-action"),children:(0,u.jsx)(Ue.Z,d()(d()({data:y,type:1,setData:k},g),{},{getEnvForm:$t}))}):(0,u.jsx)(u.Fragment,{})},kt=function(){return S!==1?(0,u.jsx)(u.Fragment,{}):(0,u.jsx)(N.r_,{data:y,setData:k,setTaskShow:mt,taskShow:vt,ref:W})},Mt=function(){return(0,u.jsxs)("div",{className:"pipeline-modify-content",children:[At(),kt(),Rt(),Nt(),Bt()]})},Bt=function(){return O?(0,u.jsx)("div",{className:"content-container common-content-container  ".concat(S===2&&"content-container-show-action"),children:(0,u.jsx)(We.Z,d()(d()({ref:Fe,data:O,setTabIndex:T},g),{},{type:1,defaultSwitchTabIndex:0}))}):(0,u.jsx)(u.Fragment,{})},Nt=function(){return O?(0,u.jsx)("div",{id:"flowline-modify-base-scroll-container",className:"content-container common-content-container  ".concat(S===0&&"content-container-show-action"),children:(0,u.jsx)(Je.Z,d()(d()({ref:x,data:O,setTabIndex:T},g),{},{type:1,defaultSwitchTabIndex:0}))}):(0,u.jsx)(u.Fragment,{})},Pt=function(){return!y||S!==1?(0,u.jsx)(u.Fragment,{}):(0,u.jsx)(Ge.Z,{data:y,type:1})},Wt=function(){return(0,u.jsx)(qe,{ref:yt})};return(0,u.jsx)(Qe._z,{children:(0,u.jsxs)("div",{className:"pipeline-container pipeline-modify-container replace-font-size-12",ref:$,children:[Mt(),Pt()]})})}var ot=ut}}]);
